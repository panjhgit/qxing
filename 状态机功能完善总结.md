# 状态机功能完善总结

## 🎯 主人物（领航者）状态机完善

### 核心状态与功能

#### 1. **Idle（待机）**
- **行为描述**：静止不动，渲染待机动画；100px 内有僵尸时自动靠近并攻击
- **触发条件**：
  - 摇杆无输入（触摸偏移≤死区）→ 保持Idle
  - 100px内出现僵尸 → 切换为Attack
- **退出条件**：
  - 摇杆有输入（触摸偏移 > 死区）→ 立即切换为Move
  - 100px内出现僵尸 → 切换为Attack
- **实现细节**：
  - 重置攻击冷却时间
  - 检测僵尸和摇杆输入状态

#### 2. **Move（移动）**
- **行为描述**：按摇杆方向移动（优先级最高）；移动中若攻击范围内有僵尸，播放攻击动画但不停止移动
- **触发条件**：摇杆有输入（触摸偏移 > 死区）→ 立即进入（无论当前状态）
- **退出条件**：
  - 摇杆输入消失 → 切换为Idle/Attack（根据是否有僵尸）
  - 移动到目标点且无新输入
- **实现细节**：
  - 移动优先级最高，可以打断任何其他状态
  - 移动中攻击：0.8秒攻击一次，不停止移动
  - 攻击动画播放但不影响移动

#### 3. **Attack（攻击）**
- **行为描述**：移动到攻击距离（50px内），触发攻击动画+伤害判定；无僵尸时切换为Idle
- **触发条件**：
  - Idle状态下，50px内有僵尸
  - Move状态结束且50px内有僵尸
- **退出条件**：
  - 摇杆有输入 → 立即切换为Move（打断攻击，移动优先级最高）
  - 僵尸死亡/超出范围 → 切换为Idle
- **实现细节**：
  - 攻击CD：1秒/次
  - 智能目标选择和攻击范围计算
  - 攻击动画播放

#### 4. **Die（死亡）**
- **行为描述**：血量≤0时触发，游戏结束
- **触发条件**：血量≤0
- **退出条件**：无（游戏结束）
- **实现细节**：
  - 死亡动画计时器（3秒）
  - 游戏结束状态设置
  - 游戏结束界面显示

### 关键状态过渡逻辑

#### 1. **移动优先级最高**
- **攻击中玩家操作摇杆**：立即从Attack → Move（打断攻击CD和动画，优先响应玩家移动指令）
- **任何状态下摇杆输入**：立即切换到Move状态（移动优先级最高）

#### 2. **移动中遇僵尸**
- 保持Move状态，若僵尸进入攻击范围，播放攻击动画但不停止移动
- 移动优先于攻击，确保玩家控制权

#### 3. **移动结束（松开摇杆）**
- 若50px内有僵尸 → Attack；无僵尸 → Idle
- 根据环境自动选择后续状态

#### 4. **攻击被打断**
- 摇杆有输入时立即打断攻击，确保移动响应性
- 攻击CD和动画重置，避免状态混乱

### 技术实现特点

#### 1. **摇杆输入检测**
```javascript
hasJoystickInput() {
    // 检查摇杆是否激活且有移动输入
    // 死区阈值：0.1，避免误触
    // 与游戏引擎摇杆系统直接连接
}
```

#### 2. **移动中攻击系统**
```javascript
playAttackAnimationWhileMoving(deltaTime) {
    // 攻击CD：0.8秒（比静止攻击稍快）
    // 不停止移动，保持玩家控制权
    // 攻击动画播放但不影响移动逻辑
}
```

#### 3. **状态优先级管理**
```javascript
// 移动状态转换优先级最高
sm.addTransition(MAIN_CHARACTER_STATES.ATTACK, MAIN_CHARACTER_STATES.MOVE, () => {
    return this.hasJoystickInput(); // 立即打断攻击
});
```

#### 4. **游戏结束处理**
```javascript
handleGameOver() {
    // 设置游戏状态为gameOver
    // 显示游戏结束界面
    // 提供重新开始选项
}
```

### 修复的Bug

1. **移动优先级不够高**：现在摇杆输入可以立即打断任何状态
2. **攻击后无法移动**：攻击状态不再阻止摇杆输入响应
3. **状态切换混乱**：清晰的状态转换条件和优先级
4. **移动中无法攻击**：移动中可以攻击，但不停止移动

### 使用说明

1. **摇杆控制**：摇杆输入优先级最高，可以打断任何状态
2. **移动中攻击**：移动时遇到僵尸会自动攻击，但不停止移动
3. **攻击被打断**：摇杆输入会立即打断攻击，确保移动响应性
4. **状态自动切换**：松开摇杆后根据环境自动选择后续状态

## 🎯 伙伴（跟随者）状态机完善

### 核心状态与功能

#### 1. **Init（初始状态）**
- **行为描述**：静止不动，渲染待机动画
- **触发条件**：主人物靠近跟随者距离20px → 切换为Follow状态
- **实现细节**：
  - 重置攻击冷却时间
  - 检测主人物接近状态

#### 2. **Idle（待机）**
- **行为描述**：静止不动，渲染待机动画
- **触发条件**：
  - 主人物Idle + 无僵尸 + 无拥堵 → 保持Idle
  - 主人物移动 → 切换为Follow
  - 100px内出现僵尸 → 切换为Attack
- **实现细节**：
  - 重置攻击冷却时间
  - 检测僵尸和主人物状态变化

#### 3. **Follow（跟随）**
- **行为描述**：按跟随规则追逐主人物侧后方跟随点
- **触发条件**：
  - 主人物处于Move状态 → 进入Follow
  - Avoid结束且主人物仍在移动 → 切换为Follow
- **退出条件**：
  - 主人物停止移动 → 切换为Idle/Attack
  - 检测到拥堵 → 切换为Avoid
- **实现细节**：
  - 每帧重新计算跟随点（避免"绕圈追"）
  - 智能跟随点计算（侧后方80px）
  - 建筑物碰撞检测和避障

#### 4. **Attack（攻击）**
- **行为描述**：移动到自身攻击距离，触发攻击动画
- **触发条件**：
  - 主人物Idle + 自身范围内有可攻击僵尸
  - Idle状态下100px内有僵尸
- **退出条件**：
  - 主人物移动 → 切换为Follow（打断攻击）
  - 僵尸死亡/超出范围 → 切换为Idle
- **实现细节**：
  - 攻击CD与主人物错开（1秒/次）
  - 智能目标选择和攻击范围计算
  - 攻击动画播放

#### 5. **Avoid（避障）**
- **行为描述**：按避障策略为主体让路
- **触发条件**：同时满足：
  - 主人物移动方向朝向自身
  - 与主人物距离 < 80px（拥堵检测）
- **退出条件**：
  - 避障完成且主人物移动 → 切换为Follow
  - 避障完成且主人物Idle → 切换为Attack
- **实现细节**：
  - 多伙伴协同避障（优先让最近的伙伴避障）
  - 智能避障方向计算（垂直于主人物移动方向）
  - 避障位置安全性验证

#### 6. **Die（死亡）**
- **行为描述**：血量≤0时触发，播放死亡动画后移除
- **触发条件**：血量≤0
- **退出条件**：死亡动画结束（2秒）→ 角色销毁
- **实现细节**：
  - 死亡动画计时器
  - 角色销毁和四叉树清理

### 关键功能实现

#### 1. **多伙伴协同避障**
```javascript
shouldEnterAvoidance(mainChar) {
    // 检查是否有其他伙伴距离主人物更近
    // 优先让最近的伙伴进入避障状态
    // 避免集体拥堵
}
```

#### 2. **跟随点动态调整**
```javascript
calculateFollowPoint() {
    // 根据主人物移动方向计算侧后方跟随点
    // 每帧重新计算，避免伙伴"绕圈追"
    // 建筑物碰撞检测和避障
}
```

#### 3. **攻击节奏控制**
```javascript
updateAttack(deltaTime) {
    // 攻击CD与主人物错开
    // 智能目标选择和攻击范围计算
    // 攻击动画播放
}
```

#### 4. **智能路径规划**
```javascript
findSafeFollowPosition() {
    // 8方向搜索安全跟随位置
    // 建筑物碰撞检测
    // 僵尸重叠检测
}
```

---

## 🧟‍♂️ 僵尸状态机完善

### 核心状态与功能

#### 1. **Idle（待机）**
- **行为描述**：静止不动，渲染待机动画；随机小范围移动（模拟"徘徊"）
- **触发条件**：700px内无主人物及伙伴
- **退出条件**：700px内出现主人物/伙伴 → 切换为Chase
- **实现细节**：
  - 0.5%概率改变游荡方向
  - 50-150px随机游荡距离
  - 游荡位置安全性验证

#### 2. **Chase（追击）**
- **行为描述**：向最近的目标（主人物优先于伙伴）移动
- **触发条件**：700px内检测到主人物/伙伴
- **退出条件**：
  - 目标进入50px内 → 切换为Attack
  - 目标超出700px → 切换为Idle
- **实现细节**：
  - 白天/夜晚速度变化（白天2m/s，夜晚3m/s）
  - 智能目标优先级（主人物 > 伙伴）
  - 实时目标位置更新

#### 3. **Attack（攻击）**
- **行为描述**：停止移动，触发攻击动画；每1秒对目标造成伤害
- **触发条件**：与目标（主人物/伙伴）距离≤50px
- **退出条件**：
  - 目标死亡/超出50px → 切换为Chase
  - 自身血量≤0 → 切换为Die
- **实现细节**：
  - 攻击冷却时间管理
  - 攻击动画播放
  - 伤害计算和应用

#### 4. **Die（死亡）**
- **行为描述**：播放死亡动画，2秒后尸体消失；概率掉落资源
- **触发条件**：血量≤0
- **退出条件**：死亡动画结束 → 实体销毁
- **实现细节**：
  - 死亡动画计时器（2秒）
  - 30%概率掉落资源（口粮60%，血包40%）
  - 四叉树清理和实体销毁

### 关键功能实现

#### 1. **白天/夜晚速度变化**
```javascript
updateDayNightState() {
    if (this.isDay) {
        this.currentMoveSpeed = this.moveSpeed; // 白天正常速度
    } else {
        this.currentMoveSpeed = this.moveSpeed * 1.67; // 夜晚速度提升
    }
}
```

#### 2. **智能游荡系统**
```javascript
idleBehavior(deltaTime) {
    // 随机游荡方向改变
    // 游荡位置安全性验证
    // 建筑物碰撞检测
}
```

#### 3. **资源掉落系统**
```javascript
dropResources() {
    var dropChance = 0.3; // 30%概率
    var resourceType = Math.random() < 0.6 ? 'food' : 'health';
    // 口粮+1，血包+20
}
```

#### 4. **死亡动画系统**
```javascript
renderDead(ctx, cameraX, cameraY) {
    // 逐渐变透明效果
    // 死亡状态视觉表现
    // 资源掉落显示
}
```

---

## 🔧 技术特性

### 1. **状态机架构**
- 清晰的状态转换条件
- 完整的状态行为方法
- 状态数据管理

### 2. **性能优化**
- 四叉树空间分区
- 智能更新策略
- 动画帧率控制

### 3. **碰撞检测**
- 建筑物碰撞检测
- 动态对象重叠检测
- 安全位置生成

### 4. **AI行为**
- 智能目标选择
- 路径规划和避障
- 多对象协同

### 5. **视觉效果**
- 状态指示器
- 白天/夜晚指示
- 动画系统

---

## 📋 使用说明

### 伙伴状态机
1. 伙伴会自动跟随主人物
2. 检测到僵尸时会主动攻击
3. 遇到拥堵时会智能避障
4. 多伙伴会协同避障，避免集体拥堵

### 僵尸状态机
1. 僵尸会在700px范围内检测目标
2. 夜晚移动速度会提升
3. 死亡后会掉落资源
4. 死亡动画持续2秒后消失

### 配置参数
- 跟随距离：80px
- 攻击范围：根据职业（20-80px）
- 拥堵检测：80px
- 僵尸检测：700px
- 攻击冷却：1秒
- 死亡动画：2秒

---

## 🚀 后续优化建议

1. **资源管理系统**：实现资源收集和背包系统
2. **技能系统**：为不同职业添加特殊技能
3. **音效系统**：添加攻击、死亡等音效
4. **粒子效果**：添加攻击特效和死亡粒子
5. **AI学习**：实现更智能的僵尸行为模式
6. **多人协作**：支持多个玩家同时游戏
